# Build and deploy the SnapMap React app to GitHub Pages (isoregret.github.io/SnapMap/)
name: Deploy SnapMap app to GitHub Pages

on:
  push:
    branches: [main]

permissions:
  contents: read
  pages: write
  id-token: write
  actions: write  # delete duplicate artifacts so deploy-pages sees exactly one

concurrency:
  group: "pages-app"
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build app for GitHub Pages
        env:
          BASE_PATH: /SnapMap/
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
        run: npm run build

      - name: Upload GitHub Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

      - name: Dedupe github-pages artifact
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          resp=$(curl -sS -H "Accept: application/vnd.github+json" -H "Authorization: Bearer $GH_TOKEN" -H "X-GitHub-Api-Version: 2022-11-28" "https://api.github.com/repos/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID/artifacts?name=github-pages&per_page=100")
          count=$(echo "$resp" | jq '.total_count')
          if [ "$count" -le 1 ]; then echo "Single artifact, nothing to dedupe"; exit 0; fi
          echo "Found $count github-pages artifacts, keeping latest and deleting duplicates"
          ids=$(echo "$resp" | jq -r '.artifacts | sort_by(.updated_at) | reverse | .[1:] | .[].id')
          for id in $ids; do
            curl -sS -X DELETE -H "Accept: application/vnd.github+json" -H "Authorization: Bearer $GH_TOKEN" -H "X-GitHub-Api-Version: 2022-11-28" "https://api.github.com/repos/$GITHUB_REPOSITORY/actions/artifacts/$id"
            echo "Deleted artifact $id"
          done

      - name: Configure GitHub Pages
        uses: actions/configure-pages@v4

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
